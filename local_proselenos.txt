LOCAL-FIRST PROSELENOS REFACTOR PLAN
=====================================
Created: 2025-12-20
Purpose: Transform Proselenos from Supabase-dependent to local-first architecture

MOTIVATION
----------
- Amazon enabling DRM-free EPUB/PDF downloads (Jan 2026) increases demand for private readers
- Total user privacy - no data leaves the device, except for AI reports and Publishing
- No server costs (just Vercel static hosting)
- No auth complexity
- No Vercel 5-minute timeout limits for AI calls (browser handles directly)
- Scales to unlimited users (just serving static files)


ARCHITECTURE OVERVIEW
---------------------
BEFORE: Browser → Vercel Serverless → Supabase (DB + Storage) + OpenRouter
AFTER:  Browser → IndexedDB (local) + OpenRouter (direct) + Vercel (Publish only)

User visits URL (needs internet to load app)
Once loaded:
  - Most functionality works offline
  - Internet only needed for:
    1. AI features (browser → OpenRouter directly)
    2. Publish (Vercel serverless generates EPUB/PDF/HTML)


WHAT'S REMOVED
--------------
1. Supabase entirely:
   - Database tables: users, author_config, projects, book_metadata, books, user_ebooks, default_tool_prompts, tool_prompts
   - Storage buckets: private-ebooks, author-files, bookstore-epubs, bookstore-covers
   - All server actions that touch Supabase

2. Authentication:
   - Google OAuth flow
   - NextAuth / auth-core package
   - User accounts

3. Cloud features:
   - Cloud backup/sync for e-reader
   - Multi-device sync
   - Bookstore (public catalog)

4. Server-side TTS:
   - edge-tts-universal
   - Recommend users use Microsoft Edge browser for built-in Read Aloud


WHAT'S KEPT
-----------
1. E-Reader core:
   - Read EPUBs from IndexedDB
   - Highlights, notes, bookmarks
   - Reading progress
   - Library management
   - Foliate-js rendering

2. Authors Mode core:
   - Manuscript editing
   - AI tools (via direct OpenRouter calls)
   - One-by-one line editing (already IndexedDB-based)
   - All converters (import/export)

3. Publish (server-side):
   - EPUB generation
   - PDF generation
   - HTML generation
   - Returns files to browser → stored in IndexedDB


SIMPLIFICATIONS
---------------
1. No projects - single manuscript at a time (like Vellum)
   - Remove project selection UI
   - Remove project CRUD
   - Just "manuscript" terminology
   - see: cls_authors_ui.png marked in red should be remove, and 
     replace Project name ("Sadie") with a Settings button = book title, author pen name, etc.

2. One AI report at a time
   - New report replaces old
   - No accumulation/history

3. One set of publish outputs
   - One EPUB, one PDF, one HTML in IndexedDB


INDEXEDDB STRUCTURE (NEW)
-------------------------
Database: ProselenosLocal (new unified database)

Stores:
  settings/
    - settings.json          # App preferences, dark mode, etc.
    - api_key.json           # OpenRouter API key (encrypted like current Proselenos)

  manuscript/
    - content.txt            # The manuscript text
    - metadata.json          # Title, author, etc. (from book_metadata)

  ai/
    - report.txt             # Current AI report (one at a time)
    - tool_prompts.json      # User's customized prompts (merged from default_tool_prompts)

  publish/
    - output.epub            # Generated EPUB (blob)
    - output.pdf             # Generated PDF (blob)
    - output.html            # Generated HTML (blob)


Note: E-Reader already uses IndexedDB (Proselenosebooks database)
      Keep it separate, as it is.



FILES TO DELETE
---------------
Server Actions (Supabase-dependent):
  apps/proselenos-app/src/lib/config-actions.ts            # Author config from Supabase
  apps/proselenos-app/src/lib/project-actions.ts           # Project CRUD
  apps/proselenos-app/src/lib/api-key-actions.ts           # API keys from Supabase
  apps/proselenos-app/src/lib/tools-actions.ts             # Tool prompts from Supabase
  apps/proselenos-app/src/lib/report-actions.ts            # Reports via server

Storage Layer:
  apps/proselenos-app/src/lib/config-storage.ts            # Supabase config ops
  apps/proselenos-app/src/lib/project-storage.ts           # Supabase project ops
  apps/proselenos-app/src/lib/tool-storage.ts              # Supabase tool ops
  apps/proselenos-app/src/lib/supabase.ts                  # Supabase client

Auth:
  packages/auth-core/                                       # Entire package
  apps/proselenos-app/src/app/api/auth/                    # Auth API routes

TTS (server-side):
  apps/proselenos-app/src/services/tts/                    # TTS service files


FILES TO MODIFY (MAJOR)
-----------------------
AI Service - Convert to client-side OpenRouter:
  apps/proselenos-app/src/lib/aiService.ts
  CHANGE: Server action → client-side fetch to OpenRouter
  CHANGE: Streaming via browser ReadableStream
  CHANGE: API key from local IndexedDB instead of Supabase

Authors Mode Pages:
  apps/proselenos-app/src/app/proselenos/                  # Main authors UI
  apps/proselenos-app/src/app/authors/                     # Authors entry
  CHANGE: Load/save manuscript from IndexedDB
  CHANGE: Remove project selection
  CHANGE: Single manuscript model

AI Tools:
  apps/proselenos-app/src/app/ai-tools/AIToolsSection.tsx
  apps/proselenos-app/src/app/ai-tools/useToolsManager.ts
  CHANGE: AI calls go browser → OpenRouter directly
  CHANGE: Reports stored in IndexedDB

Settings:
  apps/proselenos-app/src/app/proselenos/SettingsModal.tsx (or similar)
  CHANGE: API key stored/retrieved from local IndexedDB
  CHANGE: Remove cloud backup options
  CHANGE: Add export/import for local backup



FILES TO MODIFY (MINOR)
-----------------------
Navigation/Layout:
  - Remove user profile display

Environment:
  .env.web, .env.local
  - Remove SUPABASE_* variables (keep for Publish if needed)


NEW FILES TO CREATE
-------------------
Local Storage Service:
  apps/proselenos-app/src/services/localStorage/
    localStorageService.ts     # Core IndexedDB operations
    manuscriptStorage.ts       # Manuscript CRUD
    settingsStorage.ts         # Settings + API key
    aiStorage.ts               # Reports + tool prompts
    publishStorage.ts          # EPUB/PDF/HTML blobs

Client-side AI:
  apps/proselenos-app/src/services/ai/
    openRouterClient.ts        # Browser-based OpenRouter calls
    streamingHandler.ts        # SSE parsing for streaming

Export/Import:
  apps/proselenos-app/src/services/backup/
    exportService.ts           # Export library/manuscript as downloadable file
    importService.ts           # Import from file


PUBLISH FLOW (UNCHANGED SERVER-SIDE)
------------------------------------
Current files (KEEP but modify):
  apps/proselenos-app/src/lib/publish-actions.ts

Flow:
  1. Browser sends manuscript content to Vercel serverless function
  2. Server generates EPUB/PDF/HTML (existing logic)
  3. Server returns file bytes to browser
  4. Browser stores in IndexedDB (instead of Supabase Storage)

Changes:
  - Input: manuscript from request body (not Supabase)
  - Output: return file bytes (not upload to Supabase)


CONVERTERS (CLIENT-SIDE)
------------------------
These should work client-side (verify existing implementation):

1. Import .docx → .txt:
   - mammoth.js (browser-compatible)
   - File: apps/proselenos-app/src/utils/ or similar

2. Export .txt → .docx:
   - docx npm package (browser-compatible)

3. EPUB → .txt:
   - foliate-js already handles EPUB parsing

4. Extract comments from .docx:
   - mammoth.js or custom XML parser

Verify these don't depend on server-side processing.


ONE-BY-ONE EDITING (ALREADY LOCAL)
----------------------------------
These files need NO changes (already IndexedDB-based):
  apps/proselenos-app/src/app/one-by-one/OneByOneModal.tsx
  apps/proselenos-app/src/app/one-by-one/useOneByOneSession.ts
  apps/proselenos-app/src/services/oneByOne/oneByOneCache.ts
  apps/proselenos-app/src/utils/parseToolReport.ts
  apps/proselenos-app/src/utils/safeReplace.ts
  apps/proselenos-app/src/types/oneByOne.ts

The surrounding infrastructure changes (where manuscript/report come from),
but the one-by-one session management stays the same.


API KEY HANDLING
----------------
Current: Encrypted, stored in Supabase author_config.api_keys
New: No encryption, just plain text stored in local localStorage

Reference: Novelcrafter stores API keys in plain text localStorage - this is industry standard for local apps.


BACKUP/EXPORT FEATURE (NEW)
---------------------------
Since no cloud backup, provide user-controlled export:

E-Reader Export:
  - "Export Library" → ZIP containing all EPUBs + configs
  - User saves to iCloud/Drive/Dropbox themselves

Authors Export:
  - "Export Manuscript" → ZIP with manuscript.txt + metadata + outputs
  - Or simple .txt download

No ZIP imports!


USER MESSAGING
--------------
Clear communication to users:

"Proselenos keeps all your data on your device.
Once loaded, the app works without internet.

Internet is only needed for:
- AI editing tools (calls OpenRouter)
- Publishing (generates EPUB/PDF/HTML)

Your books and manuscripts never leave your browser.
Use Export to back up your data to your own cloud storage."


TTS RECOMMENDATION
------------------
Remove server-side TTS.
Add help text/documentation:

"For read-aloud, we recommend Microsoft Edge browser.
Edge has built-in Read Aloud with high-quality voices.
Select text and right-click → 'Read aloud selection'
Or use the Read Aloud button in the address bar."


IMPLEMENTATION ORDER
--------------------
Phase 1: Core Local Storage
  1. Create localStorageService.ts (IndexedDB wrapper)
  2. Create manuscriptStorage.ts
  3. Create settingsStorage.ts (including API key)
  4. Test: manuscript save/load works locally

Phase 2: Client-side AI
  5. Create openRouterClient.ts (browser → OpenRouter)
  6. Create streamingHandler.ts
  7. Modify aiService.ts to use client-side calls
  8. Test: AI tools work with direct OpenRouter calls

Phase 3: Authors Mode Refactor
  9. Remove project concept (single manuscript)
  10. Update UI to load/save from IndexedDB
  11. Update AI tools to use new client-side AI
  12. Update reports to save to IndexedDB
  13. Test: Full authors workflow works locally

Phase 5: Publish Refactor
  18. Modify publish-actions.ts to return bytes (not upload)
  19. Store returned files in IndexedDB
  20. Test: Publish generates files, stores locally

Phase 6: Cleanup
  21. Delete Supabase-dependent files
  22. Delete auth files
  23. Delete bookstore
  24. Delete server-side TTS
  25. Remove unused environment variables
  26. Update navigation (remove sign-in, bookstore links)

Phase 7: Export/Import
  27. Create exportService.ts
  28. Create importService.ts
  29. Add UI for export/import
  30. Test: User can backup and restore

Phase 8: Polish
  31. Update user messaging/help text
  32. Add TTS recommendation
  33. TypeScript checks (npx tsc --noEmit)
  34. Full testing


VERIFICATION CHECKLIST
----------------------
[ ] App loads from Vercel
[ ] No Supabase calls (check Network tab)
[ ] Manuscript saves to IndexedDB
[ ] Manuscript loads from IndexedDB
[ ] API key saves to IndexedDB (encrypted)
[ ] AI tools call OpenRouter directly from browser
[ ] AI responses stream correctly
[ ] One-by-one editing works (Accept/Skip/Custom)
[ ] Publish generates EPUB/PDF/HTML
[ ] Published files stored in IndexedDB
[ ] E-reader loads books from IndexedDB
[ ] Reading progress saves locally
[ ] Highlights/notes save locally
[ ] Export creates downloadable file
[ ] Import restores from file
[ ] No sign-in required
[ ] No bookstore visible
[ ] Works in Chrome
[ ] Works in Edge
[ ] App works offline (after initial load) except AI/Publish


OPEN QUESTIONS
--------------
1. Consolidate IndexedDB databases?
   - Currently: Proselenosebooks (e-reader), ProselenosOneByOne (editing)
   - Add: ProselenosLocal (authors/settings)
   - Or: Merge into single database?

2. Default tool prompts?
   - Currently from Supabase default_tool_prompts table
   - Option A: Hardcode in app
   - Option B: JSON file served statically
   - Option C: Bundled in build
   Prefer to "put" into IndexedDB so users can edit them

3. Converters verification?
   - Need to verify .docx import/export works client-side, 
     or keep server-side but "put" into IndexedDB
   - May need to adjust if currently server-dependent


REFERENCE: OPENROUTER TEST FILE
-------------------------------
Working proof-of-concept for client-side streaming:
  /Users/cleesmith/proselenos/openrouter-test.html

Demonstrates:
  - Browser → OpenRouter direct calls
  - Streaming via fetch + ReadableStream
  - API key in localStorage
  - Conversation history
  - Works without any server

Use this pattern for the production AI client.

And we're on a new branch to dev these changes for Proselenos:
cleesmith:~/proselenos$ git branch
* local-first
  main

